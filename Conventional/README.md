# Energy landscape analysis by the conventional likelihood maximization method

When you use the code provided here, please cite the following paper:

[P. Khanra, J. Nakuci, S. Muldoon, T. Watanabe, N. Masuda, Reliability of energy landscape analysis of resting-state functional MRI data, arXiv preprint arXiv:2305.19573](https://arxiv.org/abs/2305.19573)

# What is this repository?

The code in this folder provides the MATLAB code of key functions to perform the energy landscape analysis on multi-variate time series data like fMRI data using the conventional gradient-ascent algorithm to maximize the likelihood estimation and to estimate the parameter values. The code in this folder estimates the four discrepancy measures proposed in Khanra *et al.* (2023).[PK: It will not calculate the ND and permutation test results. These are the basic codes to calculate energy landscape analysis, estimate the parameter values and estimate the discrepancy measures. In this code we are calculating d1 and d2. Users need to take the ratio only to calculate ND.] [NM: But users do not want to take the ratio themselves. Don't make them work. We need to work.][PK: I have updated the code and also the output section here]

# Required software and packages:

- MATLAB2020 or later
- MATLAB Statistics and Machine Learning Toolbox

# How to use the code?

Because it is difficult to creat a general code which can perform energy landscape analysis for any arbitrary data, we provide the MATLAB codes and key functions for example analysis and to calculate the parameter values with the four discrepancy measures proposed in the above mentioned article.

To start with, run `Energy_landscape_analysis.m` to calculate the parameter values and the four discrepancy measures. The key functions used in this code are as follows:

- `main.m`: This function estimates the parameter of the Ising model using the maximum likelihood method. This is a modification of the code developed by Takahiro Ezaki. For more details about his code and related functions, please refer to [Takahiro's Github repository](https://github.com/tkEzaki/energy-landscape-analysis).

- `branch_index.m`: This function calculates the index (i.e, state number) [NM: What does "index" mean?][PK: Sorry, I thought it's a standard term. Now I have mentioned.] for the significant local minimum calculated for an energy landscape with a given threshold (i.e., $\mu'+2\sigma'$ to discard the insignificant local minimum; see subsection $2.7.2$ in the aforementioned paper for details about the threshold). This function also calculates the sum of the branch length ("tbl") for all the significant local minima.

- `Hamming_Distance.m`: This function calculates the Hamming distance between the activity patterns of two energy landscapes. "index1" denotes the index of significant local minima calculated for the first energy landscape and "index2" denotes the index of significant local minima calculated for the second energy landscape. The local minima corresponding to "index1" and those corresponding to "index2" have to come from two different energy landscapes. (see subsection $2.7.2$ and Eq. (23)).

- `Cosine_distance.m`: This function calculates the cosine distance between the averaged activity pattern over the attractive basin corresponding to two energy landscapes. It takes **BasinGraph1** and **BasinGraph2** as two key inputs. "BasinGraph1" indicates the BasinGraph for the first energy landscape and "BasinGraph2" indicates the BasinGraph for the second energy landscape. BasinGraph is a $2^N \times 3$ matrix, where the first column represents the state number (from 1 to $2^N$ [NM: If it is from 0 to $2^N-1$, please correct it.][No, it's correct. But I have changed the term "ID" to number. Because this is originally the state number, it's not an ID of something], the second column represents the neighboring state that has the minimum energy value, and the third column represents the local minimum state that the state in the first column belongs to. See subsection $2.7.3$ in the above article for the distance, and see [Takahiro's Github repository](https://github.com/tkEzaki/energy-landscape-analysis) for the structure of the BasinGraph.

# Sample dataset:

We provide four binarized dummy data files named `SampleData_Binarized_Participant_i_Session_j.mat`, [NM: Subject is an unacceptable language nowadays. So, including the code, please replace Subject(s)/subject(s) by Participant(s)/participant(s).] [PK: Corrected] each of which contains 7 ROIs and 1000 time points.  $i=1,2$ denotes the participants, and $j=1,2$ denotes the sessions.
If you run `Energy_landscape_analysis.m`, it reads these .mat files and run the analysis. If you want to run the analysis with different data sets, you only need to replace the data file name in line 19 and 56 in `Energy_landscape_analysis.m`.

# Input:
- Number of ROIs, set in line 2 in `Energy_landscape_analysis.m`.
- List of participants, set in line 3 of the same file.
- List of sessions, set in line 4 of the same file.
- Threshold (i.e., $\mu' + 2\sigma'$ in subsection $2.7.2$ in Khanra *et al.* (2023)) to choose significant local minima, set in line 5 of the same file.
- Name of the binarized data file, set in lines 19 and 56.

# Output:
- "h_L_i_j.mat" contains the estimated $[h_1, \ldots, h_N]$ values for the $j$ th [NM: Can you fix this dollar mark? I don't know when it is automatically converted to latex math and when it is not. Also in other places.][PK: I have changed the other places, but here it should not be in dollar sign, otherwise it will not match with the file name.] [NM: Dollar sign means math mode. dollar j dollar means italic j in latex. This is what I need. I am saying i and j must be italic. Yes they must.] [PK: Thanks, understand. I have corrected.] session from the $i$ th participant. [NM: Confusing because the conventional method, which this folder is about, only estimates one energy landscape for the set of sessions, right? The Bayesian does estimate hi and Jij for each participant and each session, but Bayesian is the other folder.][PK: No, conventional method in this folder also estimates hi and Jij for all the participants and sessions. Suppose here are 2 participants and 2 sessions in the sample data. So there will be four hi file as "h_L_1_1.mat", "h_L_1_2.mat", "h_L_2_1.mat" and "h_L_2_2,mat" and same for the Jij files. If you run the code `Energy_landscape_analysis.m`, all the things will be done.] [NM: I should say  you need to rewrite code for users. Otherwise, nobody except you can really use the code. If the code takes multiple .mat files as input, then it should output just one energy landscape for the concatenated data. If it is given just one .mat file as input, then it should return just one energy landscape. This is the most natural and intutiive, right?][PK: I don't understand why you think so that nobody can use the code. I have written the code `Energy_landscape_analysis.m` in most general way. Don't confuse the input and output data structure with Bayesian. In conventional and Bayesian the data structure is completely different. I don't understand why the code should output just one energy landscape for the concatenated data? If user doesn't need to concatenate data (like HCP in our case) then they will give the input as a separate individual and sessions and the code will read all the participants and sessions data one by one and will give the output (energy landscape i.e, parameter value) for each sessions and participants separately. If they need to concatenate the data then they can give the input data file as a concatenated file and they can get the energy landscape for each concatenated file. If someone go through the code it is very clear there. In our case in MSC data, we have 8 participants and 10 sessions. Now if we want to calculate energy landscape for each individual separately, then we have to provide 80 dataset (in .mat file and in the same data structure as in the sample data) and the code will output 80 energy landscape (parameter values) along with the four discrepancy measures and ND value. Now, if we want to concatenate the data suppose 4 participants concatenation (without random choosing), then we will have $2 \times 10 = 20$ datasets and when we give the concatenated binarized data as input, the code will output 20 energy landscape along with the discrepancy measures. Now, if you want me to save all the hi files in one file (like in a cell array) and take the output in a single mat file, also same for the Jij, then this is another thing. ] [PK: Till now I couldn't understand this part properly. But what I think you want all the output hi files in one file (like in one cell array) and same for the Jij. Am i right?]
- "J_L_i_j.mat" contains the estimated $[J_{11}, J_{12}, \ldots, J_{1,N};J_{21}, J_{22}, \ldots, J_{2,N}; \ldots ;J_{N,1},J_{N,2}, \ldots , J_{N,N}]$ values for the $j$ th session from the $i$ th participant.[PK: Data structure (Input and Output both) in Conventionl and Bayesian method is completely diferent.]
- "d1_\*" [NM: Is this the output file name? If so, please replace "indicates" by "contains" and same for other instances below.] [PK: Thanks, I have corrected this one.] contains the discrepancy measures calculated for within-participant comparison, and "d2_\*" contains the same for between-participant comparison. [NM: pairwise MEM Estimation algorithm and test-retest algorithm should be separeted completely. For example, it is entirely possible to estimate the pairwise MEM by the Bayesian method (not by likelihood maximization) and then turn to part of (?) this code to conduct test-retest reliability analysis.][PK: This code will only calculate the parameter value and all the four discrepancy measures for the original data only. For the permutation test just to do the permutation with the data and run the same analysis with these codes. Should we provide a separate code for this also?] [NM: Eventually yes, but let's prioritize all other parts for now.] [PK: Okay, thanks.]. Here "\*" denotes the four discrepancy measures defined in Khanra * et al.* 2023 as follows:
    - "Interaction_strength": indicates the discrepancy measure $d_J$.
    - "Hamming_dist":  indicates the discrepancy measure $d_H$.
    - "Cosine_dist": indicates the discrepancy measure $d_\rm{basin}$.
    - "nbld": indicates the discrepancy measure $d_L$.
- "Discrepancy.mat" contains the four ND value as follows:
    - "ND_Interaction_strength": contains the ND value for the discrepancy measure $d_J$.
    - "ND_Hamming_dist"; contains the ND value for the discrepancy measure $d_H$.
    - "ND_Cosine_dist": contains the ND value for the discrepancy measure $d_\rm{basin}$.
    - "ND_nbld": contains the ND value for the discrepancy measure $d_L$.
